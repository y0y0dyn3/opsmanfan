## SCOM 2012 – Actionable Web Application Alerts – A Scripted Solution

![Image](https://github.com/y0y0dyn3/opsmanfan/blob/master/ActionableWebAlerts/docs/Banner.png)

This is an old Operations Manager topic with numerous posts in various forums. The Web Application Transaction Monitoring in Operations manager is a very robust tool that we rely on heavily. The rollup alerts generated by the default templates on the other hand, not so much.

The concept of the rollup is great. It gives you an overall health status on an entire application and limits the number of alerts that fire. And that is perfect if you have a dedicated monitoring operations team that lives in the OpsMgr Console.

If, however, you are in a shop where most of the data goes directly to a ticket, or through some sort of messaging system straight to the responsible engineering team, this is what you are presented with:

![Image](https://github.com/y0y0dyn3/opsmanfan/blob/master/ActionableWebAlerts/docs/UnitMonitors.png)

So there is your engineer, staring at this at 2AM. Now they have to get out of bed, VPN in, and check the console, or just go straight to their application to see what is happening. Then they may find that the issue is something that could wait until morning. Uggh!

The fix? Open up the Management Pack Templates pane in the Operations Console, disable the rollups, and turn on the unit monitors. In addition you can put alert context information in the alert descriptions. This is a very labor intensive process through the UI however. Just consider the following slide:


![Image](https://github.com/y0y0dyn3/opsmanfan/blob/master/ActionableWebAlerts/docs/rollup.png)

There are 9 Unit monitors for each Transaction Step. And that is only if you haven’t turned on some of the optional settings like content matches. In this MP example (which includes one content match) with three steps, you would have to turn off 6 Rollup Monitors, and modify 28(!) unit monitors using the UI. How many of us have enough time to do that?

I don’t. So, I wrote a script. This script will go through an MP, find all the Monitors and Alerts generated by the Web Application Transaction Monitoring Template, turns off the rollups, and turns on all of the unit monitors, and puts useful alert information in the alert descriptions.

So now the Email that your engineer gets at 2AM looks like the following. You have request data, response data, error codes, and a somewhat helpful alert name.


Content Match - Detailed Alerts

*
*

****Request Data and Parameters****

RequestUrl: http://www.pythonchallenge.com/pc/phonebook.php

RequestHeaders: POST /pc/phonebook.php HTTP/1.1
User-Agent: Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1)
Accept: */*
Accept-Language: en-us
Accept-Encoding: GZIP
Content-Type: application/xml
Connection: Keep-Alive
Content-Length: 154



****End Request Data and Parameters****


****Response Data****

ResponseUrl: http://www.pythonchallenge.com/pc/phonebook.php

StatusCode: 200

ErrorCode: 0 : See Error Code Guide @ http://somehost.rackspace.com/directory/SCOMKBArticle

ResponseHeaders: HTTP/1.1 200 OK
Date: Fri, 28 Sep 2012 20:45:55 GMT
Content-Length: 134
Content-Type: text/xml
Server: lighttpd/1.4.28
Vary: Accept-Charset
X-Powered-By: PHP/5.3.3-7+squeeze8



ResponseBody: <?xml version="1.0"?>
\<methodResponse>
\<params>
\<param>
\<value><string>555-ITALY</string></value>
\</param>
\</params>
\</methodResponse>

****End Response Data****


****Network Reponse****

DNSResolutionTime: 9.12127099952648E-04

\Raw Context Data: <DataItem type="Microsoft.SystemCenter.WebApplication.WebApplicationData" time="2012-09-28T15:45:53.0041177-05:00" sourceHealthServiceId="4AEC9B8F-4E7F-552B-C0AD-C2B21161B85D"><RequestResults><RequestResult Id="1"><State>1</State><BasePageData><ResponseUrl>http://google.com</ResponseUrl><DNSResolutionTime>0</DNSResolutionTime><TCPConnectTime>0</TCPConnectTime><TimeToFirstByte>0</TimeToFirstByte><TimeToLastByte>0</TimeToLastByte><RedirectTime>0</RedirectTime><DownloadTime>0</DownloadTime><TotalResponseTime>0</TotalResponseTime><ContentSize>0</ContentSize><StatusCode>0</StatusCode><ErrorCode>2147954429</ErrorCode><ContentHash>{00000000-0000-
\]]></ResponseHeaders><ContentChanged Type="Boolean">false</ContentChanged><ResponseBody><![CDATA[<?xml version="1.0"?>
\<methodResponse>
\<params>
\<param>
\<value><string>555-ITALY</string></value>
\</param>
\</params>
\</methodResponse>]]></ResponseBody><SecureFailureCode>0</SecureFailureCode><DaysToExpiry>4294967295</DaysToExpiry><RequestUrl>http://www.pythonchallenge.com/pc/phonebook.php</RequestUrl><RequestHeaders><![CDATA[POST /pc/phonebook.php HTTP/1.1
User-Agent: Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1)
Accept: */*
Accept-Language: en-us
Accept-Encoding: GZIP
Content-Type: application/xml
Connection: Keep-Alive
Content-Length: 154

\]]></RequestHeaders><Verb>POST</Verb><Version>HTTP/1.1</Version><DNSResolutionTimeEvalResult>0</DNSResolutionTimeEvalResult><TCPConnectTimeEvalResult>0</TCPConnectTimeEvalResult><TimeToFirstByteEvalResult>0</TimeToFirstByteEvalResult><TimeToLastByteEvalResult>0</TimeToLastByteEvalResult><RedirectTimeEvalResult>0</RedirectTimeEvalResult><DownloadTimeEvalResult>0</DownloadTimeEvalResult><TotalResponseTimeEvalResult>0</TotalResponseTimeEvalResult><ContentSizeEvalResult>0</ContentSizeEvalResult><ResponseBodyEvalResult>3</ResponseBodyEvalResult><StatusCodeEvalResult>1</StatusCodeEvalResult><ErrorCodeEvalResult>0</ErrorCodeEvalResult><CustomCriteriaEvalResult>0</CustomCriteriaEvalResult><DaysToExpiryEvalResult>0</DaysToExpiryEvalResult><CertificateExpired Type="Boolean">false</CertificateExpired><CertificateAuthorityUntrusted Type="Boolean">false</CertificateAuthorityUntrusted><CertificateCNInvalid Type="Boolean">false</CertificateCNInvalid><DNSResolutionFailure Type="Boolean">false</DNSResol
		

******Truncated******

And of course you can alter this to suit your own needs. And yes, it is one of the ugliest scripts ever.

There are some caveats to this script.

1. Please test thoroughly before putting anything altered by this script into your production environment.
2. I have tested this with an MP that has Web Transaction, Web Availability, and TCP Port check monitors. 
   In our environment, these are typically the only monitor types that we will have side by side in one MP.
   Have ODBC, Windows Service Monitors, Linux BASH, etc etc in the same MP? I do not expect an issue, but Test, Test, Test. Did I say test?
3. If you use this script, then make a change, such as the addition of a content check, you will have to manually update the new unit monitor, or process it through the script again.
4. This script will ignore any Unit Monitors that have already been turned on, or Roll Ups that have been turned off.
   So it is safe to use against already modified MPs. Once again though, test and keep backups just in case.
5. This has only been tested against a 2012 environement. I am not familiar enough with the 1.0 version of the schema used in 2007 R2 to know
   if this script will work against MPs generated there.
6. This has not been tested with multiple language packs installed and likely will not work

I have attached the Powershell script, a sample base MP, and the modified MP. It has two monitors, one with three steps and a content match, and one with a single step. Hopefully this makes your life a little easier.

[A Zip file with the Powershell Script, Unmodifed MP example and Modified MP Example.](https://github.com/y0y0dyn3/opsmanfan/blob/master/ActionableWebAlerts/docs/DetailedAlerts.zip)

